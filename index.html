<html>
<head>
<title>AI Face Detection</title>	
	<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-151177504-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-151177504-1');
</script>

	
  <meta name="viewport" content="width=device-width,initial-scale-1.0">
  <meta http-equiv="X-UA-Compatible" content="ie-edge">
  <meta name="description" content="Let the AI detect the face(s), gender, age and face expressions on your instagram profile picture">	

  
	
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  
  <script src="js-css/face-api.js"></script>
  <script src="js-css/index.js"></script>
  
 <link rel="stylesheet" type="text/css" href="js-css/index.css">
	
	
  
<script>
  
async function requestInstagramProfilePic(accountName) {
  document.getElementById('expressions').innerHTML='';
  console.log("POSTMAN2");
  console.log(JSON.stringify({ accountName }));
  const res = await fetch('instagram', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ accountName })
  })
  //console.log(body);
  if (!(res.status < 400)) {
    console.error(res.status + ' : ' + await res.text());
    document.getElementById('expressions').innerHTML='<h1 style="font-color:red;">something went wrong üò¢ please make sure you write the instagram account name correctly or check back later üòª in the mean time, you can play with below profiles to see how it works üòè </h1>'
    $(".loader").fadeOut("slow");
    throw new Error('failed to fetch instagram profile pic from url: ' + accountName)
  } else {
    console.log(res)
  }    
  
  let blob
  try {
    blob = await res.blob();
    const img =  await faceapi.bufferToImage(blob);
    $('#gandhi').get(0).src = img.src ;
    await updateResults();  
    return 0;
  } catch (e) {
    console.error('received blob:', blob)
    console.error('error:', e)
    throw new Error('failed to load image from url: ' + imageUrl)
  }

}

  
</script>
  
	
	<script>
      Promise.all([
        faceapi.nets.faceRecognitionNet.loadFromUri('../model'),
        faceapi.nets.tinyFaceDetector.loadFromUri('../model'),
        faceapi.nets.ssdMobilenetv1.loadFromUri('../model'),  
        faceapi.nets.ageGenderNet.loadFromUri('../model'),
        faceapi.nets.faceLandmark68Net.loadFromUri('../model'),
        faceapi.nets.faceExpressionNet.loadFromUri('../model')
        ]).then(start)
    
      async function start() {
	console.log("started");
	await run(); 
	$(".loader").fadeOut("slow");      
	var pathname = window.location.href;
	console.log(pathname);
	if (pathname.substr(0, 47)=='https://instagram-face.herokuapp.com/?username=') {
		$(".loader").fadeIn();
		document.getElementById('ip').value = pathname.substr(47, 100);
		getInstaPage(pathname.substr(47, 100));
	}
			     
			     }
  </script>
	
	
  <script>
	function getInstaPage(x) {
		history.pushState(null, null, 'https://instagram-face.herokuapp.com/?username='+x);
		$(".loader").fadeIn();
		gtag('config', 'UA-151177504-1', {'page_path': '/'+x});
		requestInstagramProfilePic(x);
	}
  </script>
    
</head>
<body>
  <div class="loader"></div>
  <div class="center-screen">
  <h1>write your (or friend's) instagram account name and let the AI detect the face(s), gender, age and face expressions</h1>
  <h1>profile name: 
  <input class="txt" type="text" name="ip" id="ip"/>
  <button class="btn" onclick="getInstaPage(document.getElementById('ip').value)">show</button>
  </h1>
  
	<div class="outsideWrapper">
	    <div class="insideWrapper">
		<img id="gandhi" src="gandhi.jpg" width="150" height="150" class="coveredImage">
		<canvas id="cnvimg" class="coveringCanvas"></canvas>
	    </div>
	</div>
   	
	  <div id="expressions">
		<table class="tbl">
			<tr><td colspan=2>1) male, 74 years old</td></tr>
			<tr><td class="td-left">üò† angry</td><td class="td-right"><div class="div-right" style="width:0.34%;">0.34%</div></td></tr>
			<tr><td class="td-left">üòí disgusted</td><td class="td-right"><div class="div-right" style="width:0.01%;">0.01%</div></td></tr>
			<tr><td class="td-left">üò® fearful</td><td class="td-right"><div class="div-right" style="width:0.00%;">0.00%</div></td></tr>
			<tr><td class="td-left">üòá happy</td><td class="td-right"><div class="div-right" style="width:58.29%;">58.29%</div></td></tr>
			<tr><td class="td-left">üòê neutral</td><td class="td-right"><div class="div-right" style="width:37.23%;">37.23%</div></td></tr>
			<tr><td class="td-left">üò¢ sad</td><td class="td-right"><div class="div-right" style="width:4.12%;">4.12%</div></td></tr>
			<tr><td class="td-left">üòÆ surprised</td><td class="td-right"><div class="div-right" style="width:0.00%;">0.00%</div></td></tr>
		</table>
	</div>
	  
	<div id="people">
	   <br><br>	
	   üì∏ Check famous profiles üì∏<br>
		<ul>
		   <li><a href="https://instagram-face.herokuapp.com/?username=realdonaldtrump">Donald Trump</a></li>
		   <li><a href="https://instagram-face.herokuapp.com/?username=neymarjr">Neymar</a></li>
		   <li><a href="https://instagram-face.herokuapp.com/?username=taylorswift">Taylor Swift</a></li>
		   <li><a href="https://instagram-face.herokuapp.com/?username=beyonce">Beyonc√©</a></li>
		   <li><a href="https://instagram-face.herokuapp.com/?username=borisjohnsonmp">Boris Johnson</a></li>
		   <li><a href="https://instagram-face.herokuapp.com/?username=kimkardashian">Kim Kardashian West</a></li>	
		   <li><a href="https://instagram-face.herokuapp.com/?username=emmanuelmacron">Emmanuel Macron</a></li>			
		   <li><a href="https://instagram-face.herokuapp.com/?username=bundeskanzlerin">Angela Merkel</a></li>
		   <li><a href="https://instagram-face.herokuapp.com/?username=davidbeckham">David Beckham</a></li>	
		   <li><a href="https://instagram-face.herokuapp.com/?username=katyperry">Katy Perry</a></li>	
		   <li><a href="https://instagram-face.herokuapp.com/?username=vindiesel">Vin Diesel</a></li>	
		   <li><a href="https://instagram-face.herokuapp.com/?username=selenagomez">Selena Gomez</a></li>
		   <li><a href="https://instagram-face.herokuapp.com/?username=ronaldinho">Ronaldinho</a></li>
		   <li><a href="https://instagram-face.herokuapp.com/?username=putin.life">Vladimir Putin</a></li>
		</ul>
	</div>	
	
	  <div id="footer">made by <a href="https://github.com/mrcihandemir/instagram-face" target="_blank">MrCihanDemir</a> using <a href="https://github.com/justadudewhohacks/face-api.js" target="_blank">face-api.js</a></div>
	</div>  
    
  
      

  <script>
    
    async function loadImageFromUrl(url) {
        //const img = await requestExternalImage($('#imgUrlInput').val())
      const img = await requestExternalImage(url);
        $('#gandhi').get(0).src = img.src
    }

    async function uploadRefImage(e) {
      console.log("uploadRefImage()");
      const imgFile = $('#srcImg').get(0).files[0]
      const img = await faceapi.bufferToImage(imgFile)
      $('#refImg').get(0).src = img.src
      updateReferenceImageResults()
    }
    
    async function uploadQueryImage(e) {
      console.log("uploadQueryImage()");
      const imgFile = $('#queryImgUploadInput').get(0).files[0]
      const img = await faceapi.bufferToImage(imgFile)
      $('#queryImg').get(0).src = img.src
      updateQueryImageResults()
    }
    
    async function loadQueryImageFromUrl(url) {
      console.log("loadQueryImageFromUrl()");
      /*
      console.log(url);
      const extimg = await requestExternalImage(url);
      $('#gandhi64').get(0).src = extimg.src
      
      */
      updateReferenceImageResults();
      
    }
    
    /*
    async function updateReferenceImageResults() {
      console.log("updateReferenceImageResults()");
      const inputImgEl = $('#refImg').get(0)
      const canvas = $('#refImgOverlay').get(0)
      const fullFaceDescriptions = await faceapi
        .detectAllFaces(inputImgEl, getFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptors()
    }
    */
    
    //yeni yazƒ±ldƒ±
    
    async function clearCanvasImage() {
        console.log("clear canvas");
        var c = document.getElementById("cnvimg");
        var ctx = c.getContext("2d");
        ctx.clearRect(0, 0, 150, 150);
        ctx.beginPath();
        console.log("cleared canvas");
    }
    
    
    async function createCanvasImage() {
        console.log("begin canvas");
        await clearCanvasImage();
        var c = document.getElementById("cnvimg");
        var ctx = c.getContext("2d");
        var img = document.getElementById("gandhi"); 
        ctx.drawImage(img, 0, 0);
        console.log("end canvas");
    }
    
    
    // yeni yazƒ±ldƒ±
    async function updateReferenceImageResults() {
      console.log("updateReferenceImageResults()");
      /*
      //await createCanvasImage();  
      console.log("ok");
      
      const inputImgEl = $('#cnvimg').get(0);
      const options = getFaceDetectorOptions();
      console.log(options);
      //console.log(inputImgEl);
      //const canvas = $('#refImgOverlay').get(0)
      //var inp = document.getElementById("gandhi").src;
      
      //const inputImgEl = document.getElementById("gandhi").src;
      const detections = await faceapi.detectAllFaces(inputImgEl,options);
      console.log("detections");
      console.log(detections);
      const canvas = $('#cnvimg').get(0)
      //faceapi.matchDimensions(canvas, inputImgEl)
      faceapi.matchDimensions(canvas, inputImgEl)
      //faceapi.draw.drawDetections(canvas, faceapi.resizeResults(results, inputImgEl))
      faceapi.draw.drawDetections(canvas, faceapi.resizeResults(detections, inputImgEl))
      */
      
      /*
      bu kƒ±sƒ±m √ßalƒ±≈üƒ±yor
      const inputImgEl = $('#gandhi').get(0);
      const options = getFaceDetectorOptions();
      console.log(options);
      const results = await faceapi.detectAllFaces(inputImgEl, options).withFaceLandmarks().withFaceExpressions().withAgeAndGender().withFaceDescriptors();
      console.log("result");
      console.log(results);
      const canvas = $('#cnvimg').get(0);
      faceapi.matchDimensions(canvas, inputImgEl);
      faceapi.draw.drawDetections(canvas, faceapi.resizeResults(results, inputImgEl));
      */
      
      const img = $('#gandhi').get(0);
      const options = getFaceDetectorOptions();
      const out = $('#cnvimg').get(0);
      const ctx = out.getContext("2d");
      ctx.clearRect(0, 0, 150, 150);
      ctx.beginPath();
      const results = await faceapi.detectAllFaces(img, options).withFaceLandmarks().withFaceExpressions().withAgeAndGender().withFaceDescriptors();
      console.log(results);
      faceapi.draw.drawDetections(out, results.map(res => res.detection))
      
      i = 1;
      results.forEach(result => {
        var ndx = i;
        const { age, gender, expressions } = result;
        var vAngry = expressions.angry *100;
        var vDisgusted = expressions.disgusted *100;
        var vFearful = expressions.fearful *100;
        var vHappy = expressions.happy *100;
        var vNeutral = expressions.neutral *100;
        var vSad = expressions.sad *100;
        var vSurprised = expressions.surprised *100;
        

	var tdLeft = '<tr><td class="td-left">';
	var tdRight1 = '</td><td class="td-right"><div class="div-right" style="width:'; 
	var tdRight2 = '%;">';      
	var tdRight3 = '%</div></td></tr>';      
	var vExp = '<table class="tbl">';     
	vExp+= '<tr><td colspan=2>' + i + ') ' + gender + ', ' + faceapi.round(age, 0) + ' years old</td></tr>';
	vExp+= tdLeft + 'üò† angry' + tdRight1 + vAngry.toFixed(2) + tdRight2 + vAngry.toFixed(2) + tdRight3;     
	vExp+= tdLeft + 'üòí disgusted' + tdRight1 + vDisgusted.toFixed(2) + tdRight2 + vDisgusted.toFixed(2) + tdRight3;     
	vExp+= tdLeft + 'üò® fearful' + tdRight1 + vFearful.toFixed(2) + tdRight2 + vFearful.toFixed(2) + tdRight3;           
	vExp+= tdLeft + 'üòá happy' + tdRight1 + vHappy.toFixed(2) + tdRight2 + vHappy.toFixed(2) + tdRight3;           
	vExp+= tdLeft + 'üòê neutral' + tdRight1 + vNeutral.toFixed(2) + tdRight2 + vNeutral.toFixed(2) + tdRight3;     
	vExp+= tdLeft + 'üò¢ sad' + tdRight1 + vSad.toFixed(2) + tdRight2 + vSad.toFixed(2) + tdRight3;     
	vExp+= tdLeft + 'üòÆ surprised' + tdRight1 + vSurprised.toFixed(2) + tdRight2 + vSurprised.toFixed(2) + tdRight3;           
	vExp+= '</table>';  
	      
	var dExp = document.getElementById('expressions');
	dExp.innerHTML+= vExp;      
	      
        new faceapi.draw.DrawTextField(
          [
            //`$(i)) ${gender}, ${faceapi.round(age, 0)}`
            `${ndx}`
          ],
          result.detection.box.bottomLeft
        ).draw(out)
        i = i + 1;
       });
      
        $(".loader").fadeOut("slow");
	history.pushState(null, null, 'https://instagram-face.herokuapp.com/?username='+document.getElementById('ip').value);
        }
    
    async function updateQueryImageResults() {
      console.log("updateQueryImageResults()");
      const inputImgEl = $('#queryImg').get(0)
      const canvas = $('#queryImgOverlay').get(0)
      const results = await faceapi
        .detectAllFaces(inputImgEl, getFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptors()
      faceapi.matchDimensions(canvas, inputImgEl)
      // resize detection and landmarks in case displayed image is smaller than
      // original size
      const resizedResults = faceapi.resizeResults(results, inputImgEl)
      resizedResults.forEach(({ detection, descriptor }) => {
        const label = faceMatcher.findBestMatch(descriptor).toString()
        const options = { label }
        const drawBox = new faceapi.draw.DrawBox(detection.box, options)
        drawBox.draw(canvas)
      })
    }
    async function updateResults() {
      console.log("updateResults()");
      getFaceDetectorOptions();
      console.log("getFaceDetectorOptions");
      //await loadQueryImageFromUrl(document.getElementById("refImg").src);
      await updateReferenceImageResults()
      //await updateQueryImageResults()
    }
    async function run() {
      // load face detection, face landmark model and face recognition models
      await changeFaceDetector('ssd_mobilenetv1');
      //await faceapi.loadFaceLandmarkModel('/')
      await faceapi.loadFaceRecognitionModel('/');  
	
		    
	
    }
    /*
    $(document).ready(function() {
      renderNavBar('#navbar', 'face_recognition')
      initFaceDetectionControls()
      run()
    })
    */
  </script>
</body>
</html>
